{% extends "base.html" %}

{% block content %}
<div class="app-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-auto">
                <h1 class="h4 mb-0">
                    <i class="bi bi-images me-2"></i>{{ folder_name }}
                </h1>
                <small class="text-muted" data-i18n="header.photos_count" data-i18n-params='{"count": "{{ photos_count }}"}'>{{ photos_count }} photos</small>
            </div>
            <div class="col-auto ms-auto d-flex gap-2 align-items-center flex-wrap">
                <!-- Batch controls -->
                <div id="batchControls" class="d-flex gap-2 flex-wrap">
                    <!-- Descriptions dropdown -->
                    <div class="btn-group">
                        <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" id="btnDescribeDropdown">
                            <i class="bi bi-stars me-1"></i><span data-i18n="header.btn_descriptions">Descriptions</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="btnDescribeAll" data-i18n="header.btn_generate_all">Generate all</a></li>
                            <li><a class="dropdown-item" href="#" id="btnDescribeSelected" data-i18n="header.btn_generate_selected">Generate selected</a></li>
                        </ul>
                    </div>

                    <!-- Locate dropdown -->
                    <div class="btn-group">
                        <button class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" id="btnLocateDropdown">
                            <i class="bi bi-geo-alt me-1"></i><span data-i18n="header.btn_locate">Locate</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="btnLocateAll" data-i18n="header.btn_locate_all">Locate all</a></li>
                            <li><a class="dropdown-item" href="#" id="btnLocateSelected" data-i18n="header.btn_locate_selected">Locate selected</a></li>
                        </ul>
                    </div>

                    <!-- Save dropdown -->
                    <div class="btn-group">
                        <button class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" id="btnSaveDropdown">
                            <i class="bi bi-check-lg me-1"></i><span data-i18n="header.btn_save">Save</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="btnSaveAll" data-i18n="header.btn_save_all">Save all</a></li>
                            <li><a class="dropdown-item" href="#" id="btnSaveSelected" data-i18n="header.btn_save_selected">Save selected</a></li>
                        </ul>
                    </div>

                    <!-- Stop button -->
                    <button class="btn btn-danger d-none" id="btnStop">
                        <i class="bi bi-stop-fill me-1"></i><span data-i18n="header.btn_stop">Stop</span>
                    </button>
                </div>

                <!-- Batch status -->
                <div class="batch-status" id="batchStatus">
                    <span class="badge bg-info">
                        <i class="bi bi-hourglass-split me-1 status-processing"></i>
                        <span id="batchStatusText" data-i18n="header.batch_processing">Processing...</span>
                    </span>
                </div>

                <!-- Prompts settings -->
                <button class="btn btn-outline-secondary btn-sm" id="btnPrompts" data-i18n-title="prompts.btn_title" title="Edit AI prompts" data-bs-toggle="modal" data-bs-target="#promptsModal">
                    <i class="bi bi-chat-square-text me-1"></i><span data-i18n="header.btn_prompts">Prompts</span>
                    <span class="badge bg-info ms-1 d-none" id="presetBadge"></span>
                </button>

                <!-- Provider settings -->
                <button class="btn btn-outline-secondary btn-sm" id="btnSettings" data-i18n-title="settings.title" title="AI Provider Settings" data-bs-toggle="modal" data-bs-target="#settingsModal">
                    <i class="bi bi-gear me-1"></i><span id="providerSummary">{{ describe_provider }}/{{ locate_provider }}</span>
                </button>

                <!-- Language switcher -->
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-translate"></i> <span id="currentLang"></span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" data-lang="en">English</a></li>
                        <li><a class="dropdown-item" href="#" data-lang="cs">Čeština</a></li>
                    </ul>
                </div>

                <!-- Log toggle -->
                <button class="btn btn-outline-secondary btn-sm" id="btnToggleLog" title="Show/hide log">
                    <i class="bi bi-terminal me-1"></i><span data-i18n="header.btn_log">Log</span>
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mt-2">
            <div class="col-auto">
                <div class="form-check form-check-inline">
                    <input class="form-check-input photo-checkbox" type="checkbox" id="selectAll">
                    <label class="form-check-label" for="selectAll" data-i18n="header.select_all">Select all</label>
                </div>
            </div>
            <div class="col-auto">
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="filter" id="filterAll" value="all" checked>
                    <label class="btn btn-outline-secondary" for="filterAll" data-i18n="filter.all">All</label>

                    <input type="radio" class="btn-check" name="filter" id="filterWithDesc" value="with_description">
                    <label class="btn btn-outline-secondary" for="filterWithDesc" data-i18n="filter.with_description">With description</label>

                    <input type="radio" class="btn-check" name="filter" id="filterWithoutDesc" value="without_description">
                    <label class="btn btn-outline-secondary" for="filterWithoutDesc" data-i18n="filter.without_description">Without description</label>
                </div>
            </div>
            <div class="col-auto">
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="sort" id="sortDate" value="date" checked>
                    <label class="btn btn-outline-secondary" for="sortDate" data-i18n="sort.by_date">By date</label>

                    <input type="radio" class="btn-check" name="sort" id="sortName" value="name">
                    <label class="btn btn-outline-secondary" for="sortName" data-i18n="sort.by_name">By name</label>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div id="photosList">
        <!-- Photos will be loaded here -->
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden" data-i18n="photo.loading">Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Map Modal -->
<div class="modal fade" id="mapModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" data-i18n="map.title">Select location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="map-search-container position-relative">
                    <input type="text" class="form-control" id="mapSearch" data-i18n-placeholder="map.search_placeholder" placeholder="Search place...">
                    <div class="search-results d-none" id="searchResults"></div>
                </div>
                <div id="map"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="map.btn_cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnConfirmLocation" data-i18n="map.btn_confirm">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-gear me-2"></i><span data-i18n="settings.title">AI Provider Settings</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold" data-i18n="settings.describe_label">Description generation</label>
                    <div class="row g-2">
                        <div class="col">
                            <select class="form-select" id="describeProvider">
                                <option value="claude">Claude</option>
                                <option value="gemini">Gemini</option>
                                <option value="openai">OpenAI Codex</option>
                            </select>
                        </div>
                        <div class="col">
                            <select class="form-select" id="describeModel">
                                <!-- Filled by JS based on provider -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold" data-i18n="settings.locate_label">Localization</label>
                    <div class="row g-2">
                        <div class="col">
                            <select class="form-select" id="locateProvider">
                                <option value="claude">Claude</option>
                                <option value="gemini">Gemini</option>
                                <option value="openai">OpenAI Codex</option>
                            </select>
                        </div>
                        <div class="col">
                            <select class="form-select" id="locateModel">
                                <!-- Filled by JS based on provider -->
                            </select>
                        </div>
                    </div>
                </div>
                <hr>

                <div class="mb-3">
                    <label class="form-label fw-bold" data-i18n="settings.context_label">Description context</label>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="contextEnabled" checked>
                        <label class="form-check-label" for="contextEnabled" data-i18n="settings.context_enabled">
                            Use context from nearby photos
                        </label>
                    </div>
                    <small class="text-muted d-block mb-2" data-i18n="settings.context_help">
                        AI will receive existing descriptions from nearby photos and avoid repeating the same facts.
                    </small>
                    <div class="row g-2">
                        <div class="col">
                            <label class="form-label small" data-i18n="settings.context_radius">Radius (km)</label>
                            <input type="number" class="form-control form-control-sm" id="contextRadius"
                                   min="0.5" max="20" step="0.5" value="5">
                        </div>
                        <div class="col">
                            <label class="form-label small" data-i18n="settings.context_max_count">Max descriptions</label>
                            <input type="number" class="form-control form-control-sm" id="contextMaxCount"
                                   min="1" max="10" step="1" value="5">
                        </div>
                    </div>
                </div>

                <hr>

                <div class="alert alert-info small mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    <strong data-i18n="settings.requirements">Requirements:</strong><br>
                    Claude: CLI <code>claude</code><br>
                    Gemini: CLI <code>gemini</code><br>
                    OpenAI: CLI <code>codex</code>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="settings.btn_cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSaveSettings" data-i18n="settings.btn_save">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Prompts Modal -->
<div class="modal fade" id="promptsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-chat-square-text me-2"></i><span data-i18n="prompts.title">Edit AI Prompts</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Preset selector -->
                <div class="d-flex align-items-center gap-2 mb-3">
                    <label class="form-label mb-0 me-2" data-i18n="prompts.preset_label">Preset:</label>
                    <select class="form-select form-select-sm" id="presetSelect" style="width: auto; min-width: 200px;">
                        <option value="" data-i18n="prompts.preset_none">(none)</option>
                    </select>
                    <button class="btn btn-outline-primary btn-sm" id="btnSaveAsPreset">
                        <i class="bi bi-save me-1"></i><span data-i18n="prompts.btn_save_as">Save as...</span>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" id="btnDeletePreset">
                        <i class="bi bi-trash me-1"></i><span data-i18n="prompts.btn_delete">Delete</span>
                    </button>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs" id="promptsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="describe-tab" data-bs-toggle="tab" data-bs-target="#describe-pane" type="button" role="tab">
                            <i class="bi bi-stars me-1"></i><span data-i18n="prompts.tab_describe">Descriptions</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="locate-tab" data-bs-toggle="tab" data-bs-target="#locate-pane" type="button" role="tab">
                            <i class="bi bi-geo-alt me-1"></i><span data-i18n="prompts.tab_locate">Localization</span>
                        </button>
                    </li>
                </ul>

                <!-- Tab content -->
                <div class="tab-content pt-3" id="promptsTabContent">
                    <!-- Describe prompt -->
                    <div class="tab-pane fade show active" id="describe-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">
                                <span data-i18n="prompts.placeholders_label">Placeholders:</span> <code>{image_line}</code>, <code>{context_lines}</code>, <code>{user_hint_line}</code>, <code>{nearby_descriptions_line}</code>
                            </small>
                            <button class="btn btn-outline-secondary btn-sm" id="btnResetDescribe">
                                <i class="bi bi-arrow-counterclockwise me-1"></i><span data-i18n="prompts.btn_reset">Reset</span>
                            </button>
                        </div>
                        <textarea class="form-control font-monospace" id="describePromptText" rows="18" style="font-size: 0.85rem;"></textarea>
                    </div>

                    <!-- Locate prompt -->
                    <div class="tab-pane fade" id="locate-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">
                                <span data-i18n="prompts.placeholders_label">Placeholders:</span> <code>{image_line}</code>, <code>{timestamp}</code>, <code>{user_hint_line}</code>
                            </small>
                            <button class="btn btn-outline-secondary btn-sm" id="btnResetLocate">
                                <i class="bi bi-arrow-counterclockwise me-1"></i><span data-i18n="prompts.btn_reset">Reset</span>
                            </button>
                        </div>
                        <textarea class="form-control font-monospace" id="locatePromptText" rows="18" style="font-size: 0.85rem;"></textarea>
                    </div>
                </div>

                <div class="alert alert-info small mt-3 mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    <span data-i18n="prompts.session_notice">Changes apply only to the current session. Use "Save as..." to save a preset.</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="prompts.btn_cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSavePrompts" data-i18n="prompts.btn_save_session">Save session</button>
            </div>
        </div>
    </div>
</div>

<!-- Save Preset Modal -->
<div class="modal fade" id="savePresetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" data-i18n="preset.save_title">Save as preset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="presetName" class="form-label" data-i18n="preset.name_label">Preset name</label>
                    <input type="text" class="form-control" id="presetName" data-i18n-placeholder="preset.name_placeholder" placeholder="e.g. Vacation 2024">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="preset.btn_cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnConfirmSavePreset" data-i18n="preset.btn_save">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Prompt Preview Modal -->
<div class="modal fade" id="promptPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-code me-2"></i>
                    <span id="promptPreviewTitle">Prompt</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre class="prompt-preview-content" id="promptPreviewContent" style="white-space: pre-wrap; word-break: break-word; max-height: 60vh; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.25rem; font-size: 0.85rem;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="btnCopyPrompt">
                    <i class="bi bi-clipboard me-1"></i><span data-i18n="preview.btn_copy">Copy</span>
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="preview.btn_close">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Log Panel -->
<div id="logPanel" class="log-panel d-none">
    <div class="log-header">
        <span><i class="bi bi-terminal me-2"></i><span data-i18n="log.title">Log</span></span>
        <div>
            <button class="btn btn-sm btn-outline-light me-2" id="btnClearLog" data-i18n-title="log.btn_clear_title" title="Clear log">
                <i class="bi bi-trash"></i>
            </button>
            <button class="btn btn-sm btn-outline-light" id="btnCloseLog" data-i18n-title="log.btn_close_title" title="Close">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>
    <div class="log-content" id="logContent">
        <div class="log-entry log-info" data-i18n="log.connecting">Connecting to log...</div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>
{% endblock %}

{% block scripts %}
<script>
// Global state
let photos = [];
let selectedPhotos = new Set();
let map = null;
let mapMarker = null;
let currentMapPhotoFilename = null;
let mapSelectedCoords = null;

// Toast helper
function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();

    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-warning';
    const textClass = type === 'warning' ? 'text-dark' : 'text-white';

    container.innerHTML += `
        <div id="${toastId}" class="toast ${bgClass} ${textClass}" role="alert">
            <div class="toast-body d-flex align-items-center">
                <span>${message}</span>
                <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    const toastEl = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
    toast.show();

    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}

// Copy value from one photo's input to neighbor (up or down)
function copyValueToNeighbor(filename, fieldType, direction) {
    const currentIndex = photos.findIndex(p => p.filename === filename);
    if (currentIndex === -1) return;

    const neighborIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
    if (neighborIndex < 0 || neighborIndex >= photos.length) return;

    const neighborFilename = photos[neighborIndex].filename;

    // Get source value
    const sourceInput = document.getElementById(`${fieldType}-${filename}`);
    if (!sourceInput) return;

    const value = sourceInput.value;

    // Set target value
    const targetInput = document.getElementById(`${fieldType}-${neighborFilename}`);
    if (!targetInput) return;

    targetInput.value = value;

    // Visual feedback - briefly highlight the target input
    targetInput.classList.add('border-success');
    setTimeout(() => targetInput.classList.remove('border-success'), 500);
}

// Render copy arrows for an input field
function renderCopyArrows(filename, fieldType) {
    const currentIndex = photos.findIndex(p => p.filename === filename);
    const isFirst = currentIndex === 0;
    const isLast = currentIndex === photos.length - 1;

    const upArrow = isFirst ? '' :
        `<button type="button" class="copy-arrow-btn" onclick="copyValueToNeighbor('${filename}', '${fieldType}', 'up')" title="${t('photo.copy_up')}">↑</button>`;
    const downArrow = isLast ? '' :
        `<button type="button" class="copy-arrow-btn" onclick="copyValueToNeighbor('${filename}', '${fieldType}', 'down')" title="${t('photo.copy_down')}">↓</button>`;

    if (!upArrow && !downArrow) return '';

    return `<div class="copy-arrows">${upArrow}${downArrow}</div>`;
}

// Render photo card
function renderPhotoCard(photo) {
    const gpsStatus = photo.gps ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';

    let aiStatus, aiBadge;
    if (photo.ai_empty_response) {
        aiStatus = 'bi-exclamation-circle-fill text-warning';
        aiBadge = `<span class="badge badge-warning">${t('photo.badge_unrecognized')}</span>`;
    } else if (photo.description) {
        aiStatus = 'bi-check-circle-fill text-success';
        aiBadge = '';
    } else {
        aiStatus = 'bi-x-circle-fill text-danger';
        aiBadge = '';
    }

    const gpsValue = photo.gps ? `${photo.gps.lat.toFixed(6)}, ${photo.gps.lng.toFixed(6)}` : '';

    const isSelected = selectedPhotos.has(photo.filename);

    let aiIndicator = '';
    if (photo.ai_status === 'processing') {
        aiIndicator = '<i class="bi bi-arrow-repeat status-processing ms-1"></i>';
    }

    let locateIndicator = '';
    if (photo.locate_status === 'processing') {
        locateIndicator = '<i class="bi bi-arrow-repeat status-processing ms-1"></i>';
    } else if (photo.locate_status === 'done' && photo.locate_confidence) {
        const confIcon = photo.locate_confidence === 'high' ? 'text-success' :
                        photo.locate_confidence === 'medium' ? 'text-warning' : 'text-secondary';
        locateIndicator = `<i class="bi bi-geo-alt-fill ${confIcon} ms-1" title="${t('photo.located_title', {confidence: t('confidence.' + photo.locate_confidence)})}"></i>`;
    }

    return `
        <div class="photo-card" data-filename="${photo.filename}">
            <div class="photo-card-header">
                <input type="checkbox" class="form-check-input photo-checkbox photo-select"
                       data-filename="${photo.filename}" ${isSelected ? 'checked' : ''}>
                <strong>${photo.filename}</strong>
                <span class="ms-auto">
                    <span class="me-2" title="GPS"><i class="bi ${gpsStatus} status-icon"></i> GPS${locateIndicator}</span>
                    <span title="AI"><i class="bi ${aiStatus} status-icon"></i> AI${aiIndicator}</span>
                    ${aiBadge}
                </span>
            </div>
            <div class="photo-card-body">
                <div class="photo-image-container">
                    <img src="/api/photos/${encodeURIComponent(photo.filename)}/thumbnail"
                         class="photo-image" alt="${photo.filename}"
                         loading="lazy">
                </div>
                <div class="photo-details">
                    <div class="mb-3">
                        <label class="form-label">${t('photo.gps_label')}</label>
                        <div class="input-with-arrows">
                            <div class="input-group">
                                <input type="text" class="form-control gps-input"
                                       id="gps-${photo.filename}" value="${gpsValue}"
                                       placeholder="${t('photo.gps_placeholder')}">
                                <button class="btn btn-outline-secondary map-btn"
                                        data-filename="${photo.filename}" title="${t('photo.map_btn_title')}">
                                    <i class="bi bi-map"></i>
                                </button>
                            </div>
                            ${renderCopyArrows(photo.filename, 'gps')}
                        </div>
                        <small class="text-muted">${t('photo.gps_source', {source: t('photo.gps_source_' + (photo.gps_source || 'none'))})}</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">${t('photo.place_label')}</label>
                        <div class="input-with-arrows">
                            <input type="text" class="form-control location-input"
                                   id="loc-${photo.filename}" value="${photo.location_name || ''}"
                                   placeholder="${t('photo.place_placeholder')}">
                            ${renderCopyArrows(photo.filename, 'loc')}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">${t('photo.description_label')}</label>
                        <div class="input-with-arrows">
                            <textarea class="form-control description-textarea"
                                      id="desc-${photo.filename}">${photo.description || ''}</textarea>
                            ${renderCopyArrows(photo.filename, 'desc')}
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small text-muted">${t('photo.locate_hint_label')}</label>
                            <div class="input-with-arrows">
                                <input type="text" class="form-control form-control-sm locate-hint-input"
                                       id="locate-hint-${photo.filename}"
                                       placeholder="${t('photo.locate_hint_placeholder')}">
                                ${renderCopyArrows(photo.filename, 'locate-hint')}
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">${t('photo.describe_hint_label')}</label>
                            <div class="input-with-arrows">
                                <input type="text" class="form-control form-control-sm describe-hint-input"
                                       id="describe-hint-${photo.filename}"
                                       placeholder="${t('photo.describe_hint_placeholder')}">
                                ${renderCopyArrows(photo.filename, 'describe-hint')}
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 flex-wrap align-items-center">
                        <div class="d-flex align-items-center gap-1">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary btn-locate"
                                        data-filename="${photo.filename}">
                                    <i class="bi bi-geo-alt me-1"></i>${t('photo.btn_locate')}
                                </button>
                                <button class="btn btn-outline-secondary btn-prompt-preview"
                                        data-filename="${photo.filename}" data-type="locate"
                                        title="${t('photo.btn_show_prompt')}">
                                    <i class="bi bi-code"></i>
                                </button>
                            </div>
                            <div class="form-check form-check-inline mb-0 ms-1">
                                <input class="form-check-input" type="checkbox"
                                       id="include-image-locate-${photo.filename}" checked
                                       title="${t('photo.include_image_title')}">
                                <label class="form-check-label small" for="include-image-locate-${photo.filename}">
                                    <i class="bi bi-image"></i>
                                </label>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-1">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-generate"
                                        data-filename="${photo.filename}">
                                    <i class="bi bi-stars me-1"></i>${t('photo.btn_generate')}
                                </button>
                                <button class="btn btn-outline-primary btn-prompt-preview"
                                        data-filename="${photo.filename}" data-type="describe"
                                        title="${t('photo.btn_show_prompt')}">
                                    <i class="bi bi-code"></i>
                                </button>
                            </div>
                            <div class="form-check form-check-inline mb-0 ms-1">
                                <input class="form-check-input" type="checkbox"
                                       id="include-image-describe-${photo.filename}" checked
                                       title="${t('photo.include_image_title')}">
                                <label class="form-check-label small" for="include-image-describe-${photo.filename}">
                                    <i class="bi bi-image"></i>
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-outline-success btn-sm btn-save"
                                data-filename="${photo.filename}"
                                data-original-gps="${gpsValue}"
                                data-original-desc="${(photo.description || '').replace(/"/g, '&quot;')}"
                                data-original-loc="${(photo.location_name || '').replace(/"/g, '&quot;')}">
                            <i class="bi bi-check-lg me-1"></i>${t('photo.btn_save')}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Load and render photos
async function loadPhotos() {
    const filter = document.querySelector('input[name="filter"]:checked').value;
    const sort = document.querySelector('input[name="sort"]:checked').value;

    try {
        const response = await fetch(`/api/photos?filter=${filter}&sort=${sort}`);
        const data = await response.json();
        photos = data.photos;

        const container = document.getElementById('photosList');
        if (photos.length === 0) {
            container.innerHTML = `<div class="text-center py-5 text-muted">${t('photo.no_photos')}</div>`;
            return;
        }

        container.innerHTML = photos.map(renderPhotoCard).join('');
        updateSelectAllState();
    } catch (error) {
        console.error('Failed to load photos:', error);
        showToast(t('toast.photo_load_error'), 'error');
    }
}

// Update single photo in UI - preserves manually edited values and original data-original-* attributes
function updatePhotoInUI(filename, updatedData) {
    const photo = photos.find(p => p.filename === filename);
    if (!photo) return;

    // Capture manually edited values from DOM before re-rendering
    const gpsInput = document.getElementById(`gps-${filename}`);
    const descInput = document.getElementById(`desc-${filename}`);
    const locInput = document.getElementById(`loc-${filename}`);
    const saveBtn = document.querySelector(`.btn-save[data-filename="${filename}"]`);

    const userEdits = {
        gps: gpsInput?.value,
        description: descInput?.value,
        location_name: locInput?.value,
    };

    // Capture original values from data attributes (for unsaved changes detection)
    const originalValues = {
        gps: saveBtn?.dataset.originalGps || '',
        desc: saveBtn?.dataset.originalDesc || '',
        loc: saveBtn?.dataset.originalLoc || '',
    };

    // Merge new data into object
    Object.assign(photo, updatedData);

    // Re-render the card
    const card = document.querySelector(`.photo-card[data-filename="${filename}"]`);
    if (card) {
        card.outerHTML = renderPhotoCard(photo);
    }

    // Restore manually edited values (if updatedData doesn't contain these fields)
    const newGpsInput = document.getElementById(`gps-${filename}`);
    const newDescInput = document.getElementById(`desc-${filename}`);
    const newLocInput = document.getElementById(`loc-${filename}`);
    const newSaveBtn = document.querySelector(`.btn-save[data-filename="${filename}"]`);

    // Restore GPS if user edited and updatedData doesn't contain new gps
    if (newGpsInput && userEdits.gps && !updatedData.gps) {
        newGpsInput.value = userEdits.gps;
    }
    // Restore description if user edited and updatedData doesn't contain description
    if (newDescInput && userEdits.description && !('description' in updatedData)) {
        newDescInput.value = userEdits.description;
    }
    // Restore location_name if user edited and updatedData doesn't contain location_name
    if (newLocInput && userEdits.location_name && !('location_name' in updatedData)) {
        newLocInput.value = userEdits.location_name;
    }

    // Restore original values in data attributes (for correct unsaved changes detection)
    if (newSaveBtn) {
        newSaveBtn.dataset.originalGps = originalValues.gps;
        newSaveBtn.dataset.originalDesc = originalValues.desc;
        newSaveBtn.dataset.originalLoc = originalValues.loc;
    }

    // Check and update Save button appearance
    checkUnsavedChanges(filename);
}

// Poll task status until done
async function pollTaskStatus(taskId, filename, operation, btn) {
    const pollInterval = 500; // ms

    async function poll() {
        try {
            const response = await fetch(`/api/tasks/${taskId}`);
            const task = await response.json();

            if (task.status === 'running' || task.status === 'pending') {
                setTimeout(poll, pollInterval);
                return;
            }

            if (task.status === 'done') {
                const result = task.result;

                if (operation === 'describe') {
                    // Reset checkbox to default (checked)
                    const describeCheckbox = document.getElementById(`include-image-describe-${filename}`);
                    if (describeCheckbox) describeCheckbox.checked = true;

                    if (result.empty) {
                        updatePhotoInUI(filename, { ai_status: 'done', ai_empty_response: true });
                        showToast(t('toast.ai_unrecognized_content'), 'warning');
                    } else {
                        updatePhotoInUI(filename, {
                            description: result.description,
                            ai_status: 'done',
                            ai_empty_response: false
                        });
                        showToast(t('toast.description_generated'));
                    }
                } else if (operation === 'locate') {
                    // Reset checkbox to default (checked)
                    const locateCheckbox = document.getElementById(`include-image-locate-${filename}`);
                    if (locateCheckbox) locateCheckbox.checked = true;

                    if (result.gps) {
                        const confidenceText = t('confidence.' + result.confidence);
                        showToast(t('toast.located', {location: result.location_name || '?', confidence: confidenceText}));

                        updatePhotoInUI(filename, {
                            gps: result.gps,
                            gps_source: 'ai',
                            locate_status: 'done',
                            locate_confidence: result.confidence,
                            location_name: result.location_name
                        });
                    } else if (result.location_name) {
                        showToast(t('toast.located_no_coords', {location: result.location_name}), 'warning');
                        updatePhotoInUI(filename, {
                            locate_status: 'done',
                            locate_confidence: result.confidence,
                            location_name: result.location_name
                        });
                    } else {
                        showToast(t('toast.ai_unrecognized_place'), 'warning');
                        resetButton(btn, operation);
                        return;
                    }
                }
            } else if (task.status === 'error') {
                showToast(t('toast.error', {message: task.error}), 'error');
                resetButton(btn, operation);
                return;
            }
        } catch (error) {
            showToast(t('toast.status_check_error', {message: error.message}), 'error');
            resetButton(btn, operation);
        }
    }

    poll();
}

function resetButton(btn, operation) {
    btn.disabled = false;
    if (operation === 'describe') {
        btn.innerHTML = `<i class="bi bi-stars me-1"></i>${t('photo.btn_generate')}`;
    } else {
        btn.innerHTML = `<i class="bi bi-geo-alt me-1"></i>${t('photo.btn_locate')}`;
    }
}

// Event delegation - handle all clicks on photosList container
document.getElementById('photosList').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const filename = btn.dataset.filename;
    if (!filename) return;

    // Locate button
    if (btn.classList.contains('btn-locate')) {
        btn.disabled = true;
        btn.innerHTML = `<i class="bi bi-arrow-repeat status-processing me-1"></i>${t('btn.searching')}`;

        try {
            const locateHint = document.getElementById(`locate-hint-${filename}`)?.value || '';
            const response = await fetch(`/api/photos/${encodeURIComponent(filename)}/locate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_hint: locateHint })
            });
            const data = await response.json();

            if (data.task_id) {
                // Async task - start polling
                pollTaskStatus(data.task_id, filename, 'locate', btn);
            } else {
                showToast(t('toast.locate_failed'), 'error');
                resetButton(btn, 'locate');
            }
        } catch (error) {
            showToast(t('toast.error', {message: error.message}), 'error');
            resetButton(btn, 'locate');
        }
        return;
    }

    // Generate AI button
    if (btn.classList.contains('btn-generate')) {
        btn.disabled = true;
        btn.innerHTML = `<i class="bi bi-arrow-repeat status-processing me-1"></i>${t('btn.generating')}`;

        try {
            const describeHint = document.getElementById(`describe-hint-${filename}`)?.value || '';
            const response = await fetch(`/api/photos/${encodeURIComponent(filename)}/generate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_hint: describeHint })
            });
            const data = await response.json();

            if (data.task_id) {
                // Async task - start polling
                pollTaskStatus(data.task_id, filename, 'describe', btn);
            } else {
                showToast(t('toast.generate_failed'), 'error');
                resetButton(btn, 'describe');
            }
        } catch (error) {
            showToast(t('toast.error', {message: error.message}), 'error');
            resetButton(btn, 'describe');
        }
        return;
    }

    // Save button
    if (btn.classList.contains('btn-save')) {
        const gpsInput = document.getElementById(`gps-${filename}`);
        const descInput = document.getElementById(`desc-${filename}`);
        const locInput = document.getElementById(`loc-${filename}`);

        const payload = {
            description: descInput.value,
            location_name: locInput.value || null
        };

        // Parse GPS if provided
        const gpsValue = gpsInput.value.trim();
        if (gpsValue) {
            const parts = gpsValue.split(',').map(s => parseFloat(s.trim()));
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                payload.gps = { lat: parts[0], lng: parts[1] };
            }
        }

        btn.disabled = true;
        try {
            const response = await fetch(`/api/photos/${encodeURIComponent(filename)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                showToast(t('toast.saved_exif'));

                // Update original values in data attributes
                btn.dataset.originalGps = gpsInput.value;
                btn.dataset.originalDesc = descInput.value;
                btn.dataset.originalLoc = locInput.value;

                // Reset button appearance
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-outline-success');
                btn.innerHTML = `<i class="bi bi-check-lg me-1"></i>${t('photo.btn_save')}`;

                // Update in-memory photo state for context
                const photo = photos.find(p => p.filename === filename);
                if (photo) {
                    photo.description = descInput.value;
                    photo.location_name = locInput.value;
                    if (payload.gps) {
                        photo.gps = payload.gps;
                    }
                }
            } else {
                const error = await response.json();
                showToast(t('toast.error', {message: error.detail}), 'error');
            }
        } catch (error) {
            showToast(t('toast.error', {message: error.message}), 'error');
        }

        btn.disabled = false;
        return;
    }

    // Map button
    if (btn.classList.contains('map-btn')) {
        openMapModal(filename);
        return;
    }

    // Prompt preview button
    if (btn.classList.contains('btn-prompt-preview')) {
        const promptType = btn.dataset.type;
        showPromptPreview(filename, promptType);
        return;
    }
});

// Check if photo has unsaved changes and update save button appearance
function checkUnsavedChanges(filename) {
    const saveBtn = document.querySelector(`.btn-save[data-filename="${filename}"]`);
    if (!saveBtn) return;

    const gpsInput = document.getElementById(`gps-${filename}`);
    const descInput = document.getElementById(`desc-${filename}`);
    const locInput = document.getElementById(`loc-${filename}`);

    const originalGps = saveBtn.dataset.originalGps || '';
    const originalDesc = saveBtn.dataset.originalDesc || '';
    const originalLoc = saveBtn.dataset.originalLoc || '';

    const currentGps = gpsInput?.value || '';
    const currentDesc = descInput?.value || '';
    const currentLoc = locInput?.value || '';

    const hasChanges = currentGps !== originalGps ||
                       currentDesc !== originalDesc ||
                       currentLoc !== originalLoc;

    if (hasChanges) {
        saveBtn.classList.remove('btn-outline-success');
        saveBtn.classList.add('btn-warning');
        saveBtn.innerHTML = `<i class="bi bi-exclamation-circle me-1"></i>${t('photo.btn_save_changes')}`;
    } else {
        saveBtn.classList.remove('btn-warning');
        saveBtn.classList.add('btn-outline-success');
        saveBtn.innerHTML = `<i class="bi bi-check-lg me-1"></i>${t('photo.btn_save')}`;
    }
}

// Event delegation for checkboxes
document.getElementById('photosList').addEventListener('change', (e) => {
    if (e.target.classList.contains('photo-select')) {
        const filename = e.target.dataset.filename;
        if (e.target.checked) {
            selectedPhotos.add(filename);
        } else {
            selectedPhotos.delete(filename);
        }
        updateProcessSelectedButton();
        updateSelectAllState();
    }
});

// Event delegation for input changes (detect unsaved changes)
document.getElementById('photosList').addEventListener('input', (e) => {
    const target = e.target;
    if (target.classList.contains('gps-input') ||
        target.classList.contains('description-textarea') ||
        target.classList.contains('location-input')) {

        // Extract filename from input ID
        const idParts = target.id.split('-');
        const filename = idParts.slice(1).join('-'); // Handle filenames with dashes
        checkUnsavedChanges(filename);
    }
});

// Select all checkbox
document.getElementById('selectAll').addEventListener('change', (e) => {
    const isChecked = e.target.checked;
    document.querySelectorAll('.photo-select').forEach(cb => {
        cb.checked = isChecked;
        if (isChecked) {
            selectedPhotos.add(cb.dataset.filename);
        } else {
            selectedPhotos.delete(cb.dataset.filename);
        }
    });
    updateProcessSelectedButton();
});

function updateSelectAllState() {
    const allCheckboxes = document.querySelectorAll('.photo-select');
    const checkedCount = document.querySelectorAll('.photo-select:checked').length;
    const selectAllCb = document.getElementById('selectAll');

    if (checkedCount === 0) {
        selectAllCb.checked = false;
        selectAllCb.indeterminate = false;
    } else if (checkedCount === allCheckboxes.length) {
        selectAllCb.checked = true;
        selectAllCb.indeterminate = false;
    } else {
        selectAllCb.checked = false;
        selectAllCb.indeterminate = true;
    }
}

function updateProcessSelectedButton() {
    // Legacy - dropdown buttons for selected photos don't need this anymore
}

// Filter and sort
document.querySelectorAll('input[name="filter"], input[name="sort"]').forEach(input => {
    input.addEventListener('change', loadPhotos);
});

// Map modal
function openMapModal(filename) {
    currentMapPhotoFilename = filename;
    const photo = photos.find(p => p.filename === filename);

    const modal = new bootstrap.Modal(document.getElementById('mapModal'));
    modal.show();

    // Initialize map after modal is shown
    document.getElementById('mapModal').addEventListener('shown.bs.modal', function initMap() {
        if (!map) {
            map = L.map('map').setView([50.0755, 14.4378], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', (e) => {
                setMapMarker(e.latlng.lat, e.latlng.lng);
            });
        }

        // Set initial view based on photo GPS
        if (photo && photo.gps) {
            map.setView([photo.gps.lat, photo.gps.lng], 15);
            setMapMarker(photo.gps.lat, photo.gps.lng);
        } else {
            map.setView([50.0755, 14.4378], 5);
            if (mapMarker) {
                map.removeLayer(mapMarker);
                mapMarker = null;
            }
            mapSelectedCoords = null;
        }

        setTimeout(() => map.invalidateSize(), 100);
        this.removeEventListener('shown.bs.modal', initMap);
    }, { once: true });
}

function setMapMarker(lat, lng) {
    if (mapMarker) {
        mapMarker.setLatLng([lat, lng]);
    } else {
        mapMarker = L.marker([lat, lng]).addTo(map);
    }
    mapSelectedCoords = { lat, lng };
}

// Map search
let searchTimeout;
document.getElementById('mapSearch').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    const query = e.target.value.trim();

    if (query.length < 2) {
        document.getElementById('searchResults').classList.add('d-none');
        return;
    }

    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/geocode/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            const resultsEl = document.getElementById('searchResults');
            if (data.results.length === 0) {
                resultsEl.classList.add('d-none');
                return;
            }

            resultsEl.innerHTML = data.results.map(r => `
                <div class="search-result-item" data-lat="${r.lat}" data-lng="${r.lng}">
                    ${r.display_name}
                </div>
            `).join('');
            resultsEl.classList.remove('d-none');

            resultsEl.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', () => {
                    const lat = parseFloat(item.dataset.lat);
                    const lng = parseFloat(item.dataset.lng);
                    map.setView([lat, lng], 15);
                    setMapMarker(lat, lng);
                    resultsEl.classList.add('d-none');
                    document.getElementById('mapSearch').value = '';
                });
            });
        } catch (error) {
            console.error('Search failed:', error);
        }
    }, 300);
});

// Confirm location button
document.getElementById('btnConfirmLocation').addEventListener('click', () => {
    if (!mapSelectedCoords || !currentMapPhotoFilename) return;

    const gpsInput = document.getElementById(`gps-${currentMapPhotoFilename}`);
    if (gpsInput) {
        gpsInput.value = `${mapSelectedCoords.lat.toFixed(6)}, ${mapSelectedCoords.lng.toFixed(6)}`;
    }

    bootstrap.Modal.getInstance(document.getElementById('mapModal')).hide();
    showToast(t('toast.gps_updated'));
});

// Batch processing - Popisky
document.getElementById('btnDescribeAll').addEventListener('click', async (e) => {
    e.preventDefault();
    await startBatch(null, 'describe');
});

document.getElementById('btnDescribeSelected').addEventListener('click', async (e) => {
    e.preventDefault();
    if (selectedPhotos.size === 0) {
        showToast(t('toast.no_photos_selected'), 'warning');
        return;
    }
    await startBatch(Array.from(selectedPhotos), 'describe');
});

// Batch processing - Lokalizace
document.getElementById('btnLocateAll').addEventListener('click', async (e) => {
    e.preventDefault();
    await startBatch(null, 'locate');
});

document.getElementById('btnLocateSelected').addEventListener('click', async (e) => {
    e.preventDefault();
    if (selectedPhotos.size === 0) {
        showToast(t('toast.no_photos_selected'), 'warning');
        return;
    }
    await startBatch(Array.from(selectedPhotos), 'locate');
});

// Save all
document.getElementById('btnSaveAll').addEventListener('click', async (e) => {
    e.preventDefault();
    await savePhotos(null);
});

document.getElementById('btnSaveSelected').addEventListener('click', async (e) => {
    e.preventDefault();
    if (selectedPhotos.size === 0) {
        showToast(t('toast.no_photos_selected'), 'warning');
        return;
    }
    await savePhotos(Array.from(selectedPhotos));
});

async function savePhotos(photosList) {
    try {
        const response = await fetch('/api/photos/save-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ photos: photosList })
        });

        const data = await response.json();

        if (data.success) {
            showToast(t('toast.saved_count', {saved: data.saved, total: data.total}));
            if (data.errors && data.errors.length > 0) {
                console.error('Save errors:', data.errors);
            }
            await loadPhotos();
        } else {
            showToast(t('toast.save_failed'), 'error');
        }
    } catch (error) {
        showToast(t('toast.error', {message: error.message}), 'error');
    }
}

document.getElementById('btnStop').addEventListener('click', async () => {
    try {
        await fetch('/api/batch/stop', { method: 'POST' });
        showToast(t('toast.stopping'));
    } catch (error) {
        showToast(t('toast.error', {message: error.message}), 'error');
    }
});

async function startBatch(photosList, operation = 'describe') {
    try {
        const response = await fetch('/api/batch/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ photos: photosList, operation: operation })
        });

        if (!response.ok) {
            const error = await response.json();
            showToast(error.detail, 'error');
            return;
        }

        document.getElementById('btnDescribeDropdown').classList.add('d-none');
        document.getElementById('btnLocateDropdown').classList.add('d-none');
        document.getElementById('btnSaveDropdown').classList.add('d-none');
        document.getElementById('btnStop').classList.remove('d-none');
        document.getElementById('batchStatus').classList.add('active');
        updatePromptsButtonState(true);

        pollBatchStatus();
    } catch (error) {
        showToast(t('toast.error', {message: error.message}), 'error');
    }
}

async function pollBatchStatus() {
    try {
        const response = await fetch('/api/batch/status');
        const status = await response.json();

        const opLabel = status.operation === 'locate' ? t('batch.locate') : t('batch.descriptions');
        document.getElementById('batchStatusText').textContent =
            t('batch.status', {operation: opLabel, completed: status.completed_count, queued: status.queue_count});

        if (status.is_running) {
            // Refresh photos to show current status
            await loadPhotos();
            setTimeout(pollBatchStatus, 1000);
        } else {
            // Batch finished
            document.getElementById('btnDescribeDropdown').classList.remove('d-none');
            document.getElementById('btnLocateDropdown').classList.remove('d-none');
            document.getElementById('btnSaveDropdown').classList.remove('d-none');
            document.getElementById('btnStop').classList.add('d-none');
            document.getElementById('batchStatus').classList.remove('active');
            updatePromptsButtonState(false);
            showToast(t('toast.batch_complete'));
            await loadPhotos();
        }
    } catch (error) {
        console.error('Poll error:', error);
    }
}

// --- Log Panel ---
let logEventSource = null;

function formatLogTime(isoString) {
    const date = new Date(isoString);
    const locale = LANG === 'cs' ? 'cs-CZ' : 'en-US';
    return date.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function renderLogEntry(entry) {
    const time = formatLogTime(entry.timestamp);
    const levelClass = `log-${entry.level}`;

    let dataHtml = '';
    if (entry.data) {
        const hasLongData = entry.data.prompt || entry.data.response;
        if (hasLongData) {
            const dataId = 'data-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const content = entry.data.prompt || entry.data.response || '';
            dataHtml = `
                <span class="log-toggle-data" onclick="toggleLogData('${dataId}')">${t('log.show_detail')}</span>
                <div class="log-data d-none" id="${dataId}">${escapeHtml(content)}</div>
            `;
        }
    }

    return `
        <div class="log-entry ${levelClass}">
            <span class="log-time">${time}</span>
            <span>${escapeHtml(entry.message)}</span>
            ${dataHtml}
        </div>
    `;
}

function toggleLogData(id) {
    const el = document.getElementById(id);
    if (el) {
        el.classList.toggle('d-none');
    }
}

function addLogEntry(entry) {
    const content = document.getElementById('logContent');
    content.insertAdjacentHTML('beforeend', renderLogEntry(entry));
    // Auto-scroll to bottom
    content.scrollTop = content.scrollHeight;
}

function connectToLogStream() {
    if (logEventSource) {
        logEventSource.close();
    }

    const content = document.getElementById('logContent');
    content.innerHTML = `<div class="log-entry log-info">${t('log.connecting')}</div>`;

    logEventSource = new EventSource('/api/logs/stream');

    logEventSource.onopen = () => {
        content.innerHTML = '';
    };

    logEventSource.onmessage = (event) => {
        try {
            const entry = JSON.parse(event.data);
            addLogEntry(entry);
        } catch (e) {
            console.error('Failed to parse log entry:', e);
        }
    };

    logEventSource.onerror = () => {
        content.insertAdjacentHTML('beforeend',
            `<div class="log-entry log-error">${t('log.connection_error')}</div>`);
        setTimeout(connectToLogStream, 3000);
    };
}

function toggleLogPanel() {
    const panel = document.getElementById('logPanel');
    const isHidden = panel.classList.contains('d-none');

    if (isHidden) {
        panel.classList.remove('d-none');
        document.body.classList.add('log-open');
        connectToLogStream();
    } else {
        panel.classList.add('d-none');
        document.body.classList.remove('log-open');
        if (logEventSource) {
            logEventSource.close();
            logEventSource = null;
        }
    }
}

// Log panel buttons
document.getElementById('btnToggleLog').addEventListener('click', toggleLogPanel);
document.getElementById('btnCloseLog').addEventListener('click', toggleLogPanel);
document.getElementById('btnClearLog').addEventListener('click', async () => {
    await fetch('/api/logs', { method: 'DELETE' });
    document.getElementById('logContent').innerHTML =
        `<div class="log-entry log-info">${t('log.cleared')}</div>`;
});

// --- Provider Settings ---
const PROVIDER_MODELS = {
    claude: [
        { value: 'sonnet', label: 'Sonnet (default)' },
        { value: 'opus', label: 'Opus (reasoning)' },
        { value: 'haiku', label: 'Haiku (fast)' },
        { value: 'sonnet[1m]', label: 'Sonnet 1M context' },
    ],
    gemini: [
        { value: 'flash', label: 'Flash (default)' },
        { value: 'gemini-3-flash-preview', label: 'Gemini 3 Flash Preview' },
        { value: 'pro', label: 'Pro' },
        { value: 'ultra', label: 'Ultra' },
    ],
    openai: [
        { value: 'o3', label: 'o3 (reasoning)' },
        { value: 'o4-mini', label: 'o4-mini (fast)' },
        { value: 'gpt-5.2', label: 'GPT-5.2' },
        { value: 'gpt-5.2-pro', label: 'GPT-5.2 Pro' },
        { value: 'gpt-5-mini', label: 'GPT-5 Mini' },
        { value: 'codex-mini-latest', label: 'Codex Mini' },
    ],
};

function updateModelOptions(providerSelect, modelSelect, currentModel) {
    const provider = providerSelect.value;
    const models = PROVIDER_MODELS[provider] || [];

    modelSelect.innerHTML = models.map(m =>
        `<option value="${m.value}" ${m.value === currentModel ? 'selected' : ''}>${m.label}</option>`
    ).join('');
}

async function loadProviderSettings() {
    try {
        const [providerRes, contextRes] = await Promise.all([
            fetch('/api/settings/providers'),
            fetch('/api/settings/context'),
        ]);

        const settings = await providerRes.json();
        const contextSettings = await contextRes.json();

        document.getElementById('describeProvider').value = settings.describe_provider;
        document.getElementById('locateProvider').value = settings.locate_provider;

        updateModelOptions(
            document.getElementById('describeProvider'),
            document.getElementById('describeModel'),
            settings.describe_model
        );
        updateModelOptions(
            document.getElementById('locateProvider'),
            document.getElementById('locateModel'),
            settings.locate_model
        );

        updateProviderSummary(settings);

        // Load context settings
        document.getElementById('contextEnabled').checked = contextSettings.enabled;
        document.getElementById('contextRadius').value = contextSettings.radius_km;
        document.getElementById('contextMaxCount').value = contextSettings.max_count;
    } catch (error) {
        console.error('Failed to load provider settings:', error);
    }
}

function updateProviderSummary(settings) {
    const summary = document.getElementById('providerSummary');
    summary.textContent = `${settings.describe_provider}/${settings.locate_provider}`;
}

// Update model options when provider changes
document.getElementById('describeProvider').addEventListener('change', (e) => {
    const defaultModel = PROVIDER_MODELS[e.target.value]?.[0]?.value || 'sonnet';
    updateModelOptions(e.target, document.getElementById('describeModel'), defaultModel);
});

document.getElementById('locateProvider').addEventListener('change', (e) => {
    const defaultModel = PROVIDER_MODELS[e.target.value]?.[0]?.value || 'sonnet';
    updateModelOptions(e.target, document.getElementById('locateModel'), defaultModel);
});

// Save settings
document.getElementById('btnSaveSettings').addEventListener('click', async () => {
    const settings = {
        describe_provider: document.getElementById('describeProvider').value,
        describe_model: document.getElementById('describeModel').value,
        locate_provider: document.getElementById('locateProvider').value,
        locate_model: document.getElementById('locateModel').value,
    };

    const contextSettings = {
        enabled: document.getElementById('contextEnabled').checked,
        radius_km: parseFloat(document.getElementById('contextRadius').value),
        max_count: parseInt(document.getElementById('contextMaxCount').value),
    };

    try {
        // Save both provider and context settings
        const [providerRes, contextRes] = await Promise.all([
            fetch('/api/settings/providers', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            }),
            fetch('/api/settings/context', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(contextSettings)
            }),
        ]);

        if (providerRes.ok && contextRes.ok) {
            updateProviderSummary(settings);
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
            showToast(t('toast.settings_saved'));
        } else {
            const error = await (providerRes.ok ? contextRes : providerRes).json();
            showToast(t('toast.error', {message: error.detail}), 'error');
        }
    } catch (error) {
        showToast(t('toast.error', {message: error.message}), 'error');
    }
});

// Load settings when modal opens
document.getElementById('settingsModal').addEventListener('show.bs.modal', loadProviderSettings);

// --- Prompts Settings ---
let promptsState = {
    describePrompt: '',
    locatePrompt: '',
    defaultDescribePrompt: '',
    defaultLocatePrompt: '',
    activePreset: null,
    activePresetName: null,
    presets: {},
    originalDescribe: '',
    originalLocate: '',
};

async function loadPromptsSettings() {
    try {
        const [promptsRes, presetsRes] = await Promise.all([
            fetch('/api/settings/prompts'),
            fetch('/api/settings/presets'),
        ]);

        const prompts = await promptsRes.json();
        const presets = await presetsRes.json();

        promptsState.describePrompt = prompts.describe_prompt || prompts.default_describe_prompt;
        promptsState.locatePrompt = prompts.locate_prompt || prompts.default_locate_prompt;
        promptsState.defaultDescribePrompt = prompts.default_describe_prompt;
        promptsState.defaultLocatePrompt = prompts.default_locate_prompt;
        promptsState.activePreset = prompts.active_preset;
        promptsState.activePresetName = prompts.active_preset_name;
        promptsState.presets = presets.presets || {};

        // Store original values for unsaved changes detection
        promptsState.originalDescribe = promptsState.describePrompt;
        promptsState.originalLocate = promptsState.locatePrompt;

        // Update UI
        document.getElementById('describePromptText').value = promptsState.describePrompt;
        document.getElementById('locatePromptText').value = promptsState.locatePrompt;

        updatePresetDropdown();
        updatePresetBadge();
        updateDeletePresetButton();

    } catch (error) {
        console.error('Failed to load prompts settings:', error);
    }
}

function updatePresetDropdown() {
    const select = document.getElementById('presetSelect');
    select.innerHTML = `<option value="">${t('prompts.preset_none')}</option>`;

    for (const [key, preset] of Object.entries(promptsState.presets)) {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = preset.name;
        if (key === promptsState.activePreset) {
            option.selected = true;
        }
        select.appendChild(option);
    }
}

function updatePresetBadge() {
    const badge = document.getElementById('presetBadge');
    if (promptsState.activePresetName) {
        badge.textContent = promptsState.activePresetName;
        badge.classList.remove('d-none');
    } else {
        badge.classList.add('d-none');
    }
}

function updateDeletePresetButton() {
    const btn = document.getElementById('btnDeletePreset');
    btn.disabled = !promptsState.activePreset;
}

function hasUnsavedPromptChanges() {
    const currentDescribe = document.getElementById('describePromptText').value;
    const currentLocate = document.getElementById('locatePromptText').value;
    return currentDescribe !== promptsState.originalDescribe ||
           currentLocate !== promptsState.originalLocate;
}

// Preset dropdown change
document.getElementById('presetSelect').addEventListener('change', async (e) => {
    const key = e.target.value;

    if (!key) {
        // Reset to defaults
        promptsState.describePrompt = promptsState.defaultDescribePrompt;
        promptsState.locatePrompt = promptsState.defaultLocatePrompt;
        promptsState.activePreset = null;
        promptsState.activePresetName = null;

        document.getElementById('describePromptText').value = promptsState.describePrompt;
        document.getElementById('locatePromptText').value = promptsState.locatePrompt;

        promptsState.originalDescribe = promptsState.describePrompt;
        promptsState.originalLocate = promptsState.locatePrompt;

        updatePresetBadge();
        updateDeletePresetButton();
        return;
    }

    try {
        const response = await fetch(`/api/settings/presets/${key}/activate`, { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            promptsState.describePrompt = data.describe_prompt || promptsState.defaultDescribePrompt;
            promptsState.locatePrompt = data.locate_prompt || promptsState.defaultLocatePrompt;
            promptsState.activePreset = key;
            promptsState.activePresetName = promptsState.presets[key]?.name;

            document.getElementById('describePromptText').value = promptsState.describePrompt;
            document.getElementById('locatePromptText').value = promptsState.locatePrompt;

            promptsState.originalDescribe = promptsState.describePrompt;
            promptsState.originalLocate = promptsState.locatePrompt;

            updatePresetBadge();
            updateDeletePresetButton();
        }
    } catch (error) {
        showToast(t('toast.preset_activate_error'), 'error');
    }
});

// Reset buttons
document.getElementById('btnResetDescribe').addEventListener('click', () => {
    document.getElementById('describePromptText').value = promptsState.defaultDescribePrompt;
});

document.getElementById('btnResetLocate').addEventListener('click', () => {
    document.getElementById('locatePromptText').value = promptsState.defaultLocatePrompt;
});

// Save prompts to session
document.getElementById('btnSavePrompts').addEventListener('click', async () => {
    const describePrompt = document.getElementById('describePromptText').value;
    const locatePrompt = document.getElementById('locatePromptText').value;

    try {
        const response = await fetch('/api/settings/prompts', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                describe_prompt: describePrompt,
                locate_prompt: locatePrompt,
            })
        });

        if (response.ok) {
            promptsState.describePrompt = describePrompt;
            promptsState.locatePrompt = locatePrompt;
            promptsState.originalDescribe = describePrompt;
            promptsState.originalLocate = locatePrompt;

            bootstrap.Modal.getInstance(document.getElementById('promptsModal')).hide();
            showToast(t('toast.prompts_saved'));
        } else {
            const error = await response.json();
            showToast(t('toast.error', {message: error.detail}), 'error');
        }
    } catch (error) {
        showToast(t('toast.error', {message: error.message}), 'error');
    }
});

// Save as preset button
document.getElementById('btnSaveAsPreset').addEventListener('click', () => {
    document.getElementById('presetName').value = '';
    const savePresetModal = new bootstrap.Modal(document.getElementById('savePresetModal'));
    savePresetModal.show();
});

// Confirm save preset
document.getElementById('btnConfirmSavePreset').addEventListener('click', async () => {
    const name = document.getElementById('presetName').value.trim();
    if (!name) {
        showToast(t('toast.enter_preset_name'), 'warning');
        return;
    }

    // Generate key from name
    const key = name.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');

    const describePrompt = document.getElementById('describePromptText').value;
    const locatePrompt = document.getElementById('locatePromptText').value;

    try {
        const response = await fetch('/api/settings/presets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                key: key,
                name: name,
                describe_prompt: describePrompt,
                locate_prompt: locatePrompt,
            })
        });

        if (response.ok) {
            const data = await response.json();

            // Update local state
            promptsState.presets[key] = {
                name: name,
                describe_prompt: describePrompt,
                locate_prompt: locatePrompt,
            };
            promptsState.activePreset = key;
            promptsState.activePresetName = name;
            promptsState.describePrompt = describePrompt;
            promptsState.locatePrompt = locatePrompt;
            promptsState.originalDescribe = describePrompt;
            promptsState.originalLocate = locatePrompt;

            updatePresetDropdown();
            updatePresetBadge();
            updateDeletePresetButton();

            bootstrap.Modal.getInstance(document.getElementById('savePresetModal')).hide();
            showToast(t('toast.preset_saved', {name: name}));
        } else {
            const error = await response.json();
            showToast(t('toast.error', {message: error.detail}), 'error');
        }
    } catch (error) {
        showToast(t('toast.error', {message: error.message}), 'error');
    }
});

// Delete preset
document.getElementById('btnDeletePreset').addEventListener('click', async () => {
    if (!promptsState.activePreset) return;

    const presetName = promptsState.activePresetName || promptsState.activePreset;
    if (!confirm(t('confirm.delete_preset', {name: presetName}))) {
        return;
    }

    try {
        const response = await fetch(`/api/settings/presets/${promptsState.activePreset}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            delete promptsState.presets[promptsState.activePreset];
            promptsState.activePreset = null;
            promptsState.activePresetName = null;

            // Reset to defaults
            promptsState.describePrompt = promptsState.defaultDescribePrompt;
            promptsState.locatePrompt = promptsState.defaultLocatePrompt;
            document.getElementById('describePromptText').value = promptsState.describePrompt;
            document.getElementById('locatePromptText').value = promptsState.locatePrompt;
            promptsState.originalDescribe = promptsState.describePrompt;
            promptsState.originalLocate = promptsState.locatePrompt;

            updatePresetDropdown();
            updatePresetBadge();
            updateDeletePresetButton();

            showToast(t('toast.preset_deleted', {name: presetName}));
        } else {
            showToast(t('toast.preset_delete_error'), 'error');
        }
    } catch (error) {
        showToast(t('toast.error', {message: error.message}), 'error');
    }
});

// Prompts modal - load on show
document.getElementById('promptsModal').addEventListener('show.bs.modal', loadPromptsSettings);

// Prompts modal - check unsaved changes on hide
document.getElementById('promptsModal').addEventListener('hide.bs.modal', (e) => {
    if (hasUnsavedPromptChanges()) {
        if (!confirm(t('confirm.unsaved_prompts'))) {
            e.preventDefault();
        }
    }
});

// Disable prompts button during batch processing
function updatePromptsButtonState(batchRunning) {
    const btn = document.getElementById('btnPrompts');
    btn.disabled = batchRunning;
    btn.title = batchRunning ? t('prompts.btn_disabled_title') : t('prompts.btn_title');
}

// --- Prompt Preview ---
async function showPromptPreview(filename, promptType) {
    // Get user hint based on prompt type
    let userHint = '';
    if (promptType === 'locate') {
        userHint = document.getElementById(`locate-hint-${filename}`)?.value || '';
    } else {
        userHint = document.getElementById(`describe-hint-${filename}`)?.value || '';
    }

    // Get include_image checkbox state based on prompt type
    const checkboxId = promptType === 'locate'
        ? `include-image-locate-${filename}`
        : `include-image-describe-${filename}`;
    const includeImageCheckbox = document.getElementById(checkboxId);
    const includeImage = includeImageCheckbox ? includeImageCheckbox.checked : true;

    try {
        const response = await fetch(`/api/photos/${encodeURIComponent(filename)}/prompt-preview`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: promptType, user_hint: userHint, include_image: includeImage })
        });

        if (!response.ok) {
            throw new Error(t('toast.prompt_load_error'));
        }

        const data = await response.json();

        // Update modal title
        const title = promptType === 'locate' ? t('preview.title_locate') : t('preview.title_describe');
        const imageIndicator = includeImage ? ' ' + t('preview.with_image') : ' ' + t('preview.without_image');
        document.getElementById('promptPreviewTitle').textContent = title + imageIndicator;

        // Update modal content
        document.getElementById('promptPreviewContent').textContent = data.prompt;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('promptPreviewModal'));
        modal.show();
    } catch (error) {
        showToast(t('toast.error', {message: error.message}), 'error');
    }
}

// Copy prompt to clipboard
document.getElementById('btnCopyPrompt').addEventListener('click', async () => {
    const content = document.getElementById('promptPreviewContent').textContent;
    try {
        await navigator.clipboard.writeText(content);
        showToast(t('toast.prompt_copied'));
    } catch (error) {
        showToast(t('toast.copy_failed'), 'error');
    }
});

// Language switcher
document.getElementById('currentLang').textContent = LANG.toUpperCase();
document.querySelectorAll('[data-lang]').forEach(el => {
    el.addEventListener('click', (e) => {
        e.preventDefault();
        switchLanguage(el.dataset.lang);
    });
});

// Initial load with translations
(async () => {
    await loadTranslations(LANG);
    applyTranslations();
    loadPhotos();
})();
</script>
{% endblock %}
